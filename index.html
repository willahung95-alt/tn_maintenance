<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TN_å®¢æˆ¶ç¶­è­·ç®¡ç†ç³»çµ±</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root {
      --primary: #4361ee; --primary-light: #eef2ff; --success: #10b981;
      --success-light: #e8f7f0; --success-dark: #065f46;
      --warning: #f59e0b; --danger: #ef4444; 
      --text-main: #1e293b; --text-muted: #64748b; --text-soft: #334155;
      --bg-body: #f8fafc; --card-bg: #ffffff;
      --border: #e2e8f0; --radius-lg: 16px; --radius-md: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: var(--bg-body); color: var(--text-main); }
    
    #mainContent { display: none; }

    /* å¯†ç¢¼è¼¸å…¥æ¡†æ¨£å¼ */
    .password-container { position: relative; display: flex; align-items: center; margin-bottom: 20px; }
    .password-input { width: 100%; padding: 10px 40px 10px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; }
    .toggle-password { position: absolute; right: 10px; cursor: pointer; color: var(--text-muted); user-select: none; }

    header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    
    #versionTag { margin-left: 8px; font-size: 10px; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 20px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: 0.2s; user-select: none; }
    #versionTag:hover { border-color: var(--primary); box-shadow: 0 2px 4px rgba(67, 97, 238, 0.2); transform: translateY(-1px); }

    main { max-width: 1550px; margin: 1.5rem auto; padding: 0 1rem; }
    
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--card-bg); padding: 1.25rem; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem; border: 1px solid var(--border); }
    .stat-icon { width: 50px; height: 50px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .stat-info .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 2px; font-weight: 500; }
    .stat-info .stat-value { font-size: 2.2rem; font-weight: 800; line-height: 1; color: var(--text-soft); letter-spacing: -1px; }

    .controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: center; }
    .search-wrapper { flex: 1; position: relative; }
    
    .btn { padding: 8px 16px; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: 0.2s; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger-text { color: var(--danger); background: transparent; padding: 4px 8px; font-size: 0.85rem; }
    .btn-danger-text:hover { background: #fef2f2; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .table-container { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th { background: #f8fafc; padding: 12px 16px; font-size: 0.85rem; color: var(--text-muted); text-align: left; border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    
    .col-customer { width: 18%; }
    .col-product  { width: 16%; }
    .col-period   { width: 15%; }
    .col-schedule { width: 30%; } 
    .col-status   { width: 11%; }
    .col-action   { width: 10%; }
    th.col-action { text-align: right; padding-right: 24px; }

    .sales-tag { background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-block; margin-top: 4px; margin-right: 4px; }
    .engineer-tag { background: #fef3c7; color: #b45309; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-block; margin-top: 4px; }
    
    .month-group { display: flex; flex-wrap: wrap; gap: 3px; }
    .month-chip { padding: 2px 4px; border-radius: 3px; font-size: 11px; background: #f1f5f9; color: var(--text-muted); border: 1px solid var(--border); min-width: 32px; text-align: center; }
    .month-chip.is-done { background: var(--success-light); color: var(--success-dark); border-color: #a7f3d0; }
    .month-chip.active { border: 1.5px solid var(--primary); font-weight: 700; color: var(--primary); background: #fff; }

    .done-status-box { background: var(--success-light); color: var(--success-dark); padding: 6px 12px; border-radius: 8px; display: inline-flex; flex-direction: column; border: 1px solid #c6f6d5; min-width: 105px; }
    .done-status-box .status-title { font-size: 1rem; font-weight: 800; display: flex; align-items: center; gap: 4px; }
    .done-status-box .status-meta { font-size: 11px; opacity: 0.85; font-weight: 500; white-space: nowrap; }

    /* === å‚™è¨» iconï¼šæœ‰å…§å®¹æ‰é¡¯ç¤º + hover tooltip === */
    .note-indicator {
      color: #94a3b8;
      cursor: pointer;
      margin-left: 8px;
      vertical-align: middle;
      font-size: 18px;
      position: relative;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .note-indicator:hover { color: var(--primary); }
    .note-indicator[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      top: calc(100% + 10px);
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.95);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      max-width: 360px;
      width: max-content;
      font-size: 12px;
      line-height: 1.5;
      z-index: 9999;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
      white-space: pre-wrap;
    }
    .note-indicator[data-tooltip]:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      top: calc(100% + 2px);
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-bottom-color: rgba(15, 23, 42, 0.95);
      z-index: 9999;
    }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 999; display: none; }
    .drawer { position: fixed; right: -100%; top: 0; width: 100%; max-width: 650px; height: 100%; background: white; z-index: 1000; transition: right 0.3s ease; padding: 2rem; overflow-y: auto; }
    .drawer.open { right: 0; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; padding: 1.5rem; border-radius: var(--radius-lg); z-index: 1100; width: 90%; max-width: 400px; display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    
    .ym-manager { margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #f8fafc; }
    .ym-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
    .ym-tag { background: white; border: 1px solid var(--border); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }

    #editor-container { height: 350px; font-size: 16px; }

    /* === å‚™è¨» / æ—¥èªŒå…§å®¹æª¢è¦–æ¨£å¼ï¼ˆé€æ˜åº• + å…§è· + æ¡†ç·šï¼‰ === */
    #note-viewer{
      line-height: 1.7;
      color: var(--text-main);
      border: 1px solid var(--border);
      background: transparent;
      border-radius: 12px;
      padding: 14px 16px !important;
      margin-top: 8px;
      overflow-wrap: anywhere;
    }
    #note-viewer ul, #note-viewer ol { padding-left: 22px; margin: 6px 0; }
    #note-viewer p { margin: 0.4em 0; }
    #note-viewer blockquote {
      border-left: 4px solid var(--border);
      margin: 8px 0;
      padding-left: 12px;
      color: var(--text-muted);
    }

    /* === æ—¥èªŒå¡ç‰‡æ¨£å¼ === */
    .log-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      position: relative;
    }
    .log-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 8px;
    }
    .log-version {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }
    .log-date {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      margin-left: auto;
    }
    .log-content {
      font-size: 14px;
      color: var(--text-main);
      line-height: 1.6;
    }
    .log-content ul { padding-left: 20px; margin: 5px 0; }
    .log-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      border-top: 1px dashed var(--border);
      padding-top: 8px;
    }
  </style>
</head>
<body>

  <div class="overlay" id="pwdOverlay" style="z-index: 2000;"></div>
  <div class="modal" id="pwdModal" style="z-index: 2001; width: 300px; padding: 20px;">
    <h3 id="pwdTitle" style="margin-top:0; text-align: center; margin-bottom: 15px;">è«‹è¼¸å…¥å¯†ç¢¼</h3>
    <div class="password-container">
        <input type="password" id="inputPwd" class="password-input" placeholder="å¯†ç¢¼">
        <span class="material-symbols-rounded toggle-password" onclick="togglePwd()">visibility</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="btnPwdConfirm" class="btn btn-primary" style="flex:1; justify-content: center;">ç¢ºèª</button>
        <button id="btnPwdCancel" class="btn btn-outline" style="flex:1; justify-content: center;" onclick="cancelPwdModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="mainContent">
    <header>
      <div class="logo">
        <span class="material-symbols-rounded">analytics</span> 
        å®¢æˆ¶ç¶­è­·ç®¡ç†ç³»çµ±
        <span id="versionTag" onclick="openSystemLog('view')" title="é»æ“ŠæŸ¥çœ‹æ›´æ–°æ—¥èªŒ">v6.0</span>
      </div>
      <div style="display:flex; gap:10px;">
        <div id="modeSeg" style="display:flex; background:var(--primary-light); padding:4px; border-radius:100px;">
          <button class="mode-btn btn active" data-mode="user" type="button">æª¢è¦–æ¨¡å¼</button>
          <button class="mode-btn btn" data-mode="admin" type="button">ç®¡ç†æ¨¡å¼</button>
        </div>
        <div id="adminControls" style="display:none; gap:10px;">
          <button class="btn btn-outline" type="button" onclick="openSystemLog('edit')"><span class="material-symbols-rounded">history_edu</span>ç™¼ä½ˆæ—¥èªŒ</button>
          <button class="btn btn-primary" type="button" onclick="openEdit()"><span class="material-symbols-rounded">add</span>æ–°å¢ç¶­è­·</button>
        </div>
      </div>
    </header>

    <main>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background:#eef2ff; color:var(--primary);"><span class="material-symbols-rounded">groups</span></div>
          <div class="stat-info"><div class="stat-label">ç¸½å®¢æˆ¶æ•¸</div><div class="stat-value" id="statTotal">0</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:var(--success-light); color:var(--success);"><span class="material-symbols-rounded">check_circle</span></div>
          <div class="stat-info"><div class="stat-label" id="statDoneLabel">æœ¬æœˆå·²å®Œå·¥</div><div class="stat-value" id="statDone">0</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#fff7ed; color:var(--warning);"><span class="material-symbols-rounded">pending_actions</span></div>
          <div class="stat-info"><div class="stat-label" id="statTodoLabel">æœ¬æœˆå¾…è™•ç†</div><div class="stat-value" id="statTodo">0</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#f0fdf4; color:#15803d;"><span class="material-symbols-rounded">query_stats</span></div>
          <div class="stat-info"><div class="stat-label">æœ¬æœˆé”æˆç‡</div><div class="stat-value" id="statRate">0%</div></div>
        </div>
      </div>

      <div class="controls">
        <div class="search-wrapper">
          <span class="material-symbols-rounded" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted);">search</span>
          <input type="text" id="q" placeholder="æœå°‹å®¢æˆ¶åç¨±ã€æ¥­å‹™ã€ç”¢å“ã€å·¥ç¨‹å¸«..." style="width:100%; padding:10px 16px 10px 40px; border-radius:var(--radius-md); border:1px solid var(--border); outline:none;">
        </div>
        <input type="month" id="monthPick" class="btn btn-outline">
        <select id="scope" class="btn btn-outline">
          <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
          <option value="need" selected>æœ¬æœˆç¶­è­·</option>
        </select>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th class="col-customer">å®¢æˆ¶åç¨±</th>
              <th class="col-product">ç”¢å“ / æ¥­å‹™ / ç¶­è­·å·¥ç¨‹å¸«</th> 
              <th class="col-period">ç¶­è­·æœŸé–“</th>
              <th class="col-schedule">å…¨æœŸé€²åº¦</th>
              <th class="col-status">ç‹€æ…‹</th>
              <th class="col-action">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="overlay" id="overlay" onclick="closeDrawer()"></div>
  
  <div class="drawer" id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <h2 id="drawerTitle" style="margin:0">ç¶­è­·ç·¨è¼¯</h2>
      <button class="btn btn-outline" type="button" style="padding:5px; border-radius:50%" onclick="closeDrawer()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <form id="formEdit">
      <div id="adminOnlyFields">
        <div id="logVersionField" style="display:none; margin-bottom:12px;">
            <label style="font-size:0.85rem; font-weight:600;">æ›´æ–°ç‰ˆæœ¬è™Ÿ (å¦‚ v1.0)</label>
            <input type="text" id="logVersionInput" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;" placeholder="vYYYYMMDD">
        </div>

        <div id="customerFields">
            <div style="margin-bottom:12px;"><label style="font-size:0.85rem; font-weight:600;">å®¢æˆ¶åç¨±</label><input type="text" id="customer" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;"></div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
              <div>
                <label style="font-size:0.85rem;">ç”¢å“</label>
                <select id="product" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
                    <option value="ee-class">ee-class</option>
                    <option value="Adobe Connect">Adobe Connect</option>
                    <option value="km+">km+</option>
                    <option value="tms+">tms+</option>
                    <option value="i-reporter">i-reporter</option>
                    <option value="HyperPDM">HyperPDM</option>
                </select>
              </div>
              <div>
                <label style="font-size:0.85rem;">æ¥­å‹™</label>
                <select id="salesName" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
                    <option value="Mandy">Mandy</option>
                    <option value="Anyen">Anyen</option>
                    <option value="Jenny">Jenny</option>
                    <option value="Vincent">Vincent</option>
                    <option value="Peggy">Peggy</option>
                </select>
              </div>
            </div>

            <div style="margin-bottom:12px;">
                <label style="font-size:0.85rem;">ç¶­è­·å·¥ç¨‹å¸«</label>
                <select id="engineer" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="Willa">Willa</option>
                    <option value="Charlie">Charlie</option>
                    <option value="Lindsay">Lindsay</option>
                    <option value="Johnson">Johnson</option>
                    <option value="Isaac">Isaac</option>
                    <option value="Gary">Gary</option>
                    <option value="Eason">Eason</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
              <div><label style="font-size:0.85rem;">ç¶­è­·èµ·æ—¥</label><input type="date" id="startDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="handleDateChange('start')"></div>
              <div><label style="font-size:0.85rem;">ç¶­è­·è¨–æ—¥</label><input type="date" id="endDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="handleDateChange('end')"></div>
            </div>
            <div class="ym-manager">
              <label style="font-size:0.85rem; font-weight:600;">ç¶­è­·æœˆä»½ç®¡ç†</label>
              <div style="display:flex; gap:14px; margin-top:8px; align-items:center;">
                <label style="display:flex; gap:6px; align-items:center; font-size:0.85rem; color:var(--text-soft);">
                  <input type="checkbox" id="cycleQuarter" checked onchange="onCycleToggle('quarter')">
                  å­£ç¶­è­·
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:0.85rem; color:var(--text-soft);">
                  <input type="checkbox" id="cycleMonth" onchange="onCycleToggle('month')">
                  æœˆç¶­è­·
                </label>
              </div>
              <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="month" id="manualYM" class="btn btn-outline" style="flex:1">
                <button type="button" class="btn btn-outline" onclick="addYM()">æ‰‹å‹•æ–°å¢</button>
              </div>
              <div class="ym-list" id="ymList"></div>
            </div>
        </div>
      </div>

      <div style="margin-top:20px; margin-bottom:12px;">
        <label id="noteLabel" style="font-size:0.85rem; font-weight:600;">å…§å®¹ç·¨è¼¯</label>
        <div id="editor-wrapper"><div id="editor-container"></div></div>
        <div id="note-viewer" style="display:none;"></div>
      </div>

      <div id="adminAction" style="display:none;">
        <button type="submit" class="btn btn-primary" style="width:100%; padding:12px;">å„²å­˜ä¸¦åŒæ­¥è‡³è³‡æ–™åº«</button>
        <button type="button" id="btnDelete" class="btn btn-outline" style="width:100%; margin-top:10px; color:var(--danger);">åˆªé™¤ç´€éŒ„</button>
      </div>
    </form>
  </div>

  <div class="modal" id="doneModal">
    <h3 style="margin-top:0;">å®Œå·¥ç”³å ±</h3>
    <div style="margin-bottom:10px;"><label>å¯¦éš›å®Œå·¥æ—¥</label><input type="date" id="mDoneDate" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;"></div>
    <div style="margin-bottom:15px;"><label>ç¶­è­·å·¥ç¨‹å¸« (åŸ·è¡Œè€…)</label><select id="mEngName" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;"><option value="Willa">Willa</option><option value="Charlie">Charlie</option><option value="Lindsay">Lindsay</option><option value="Johnson">Johnson</option><option value="Isaac">Isaac</option></select></div>
    <div style="display:flex; gap:10px;"><button id="mSave" type="button" class="btn btn-primary" style="flex:1;">æäº¤</button><button type="button" onclick="closeModal()" class="btn btn-outline" style="flex:1;">å–æ¶ˆ</button></div>
  </div>

<script>
  // è«‹ç¢ºèª API_URL æ˜¯æœ€æ–°çš„
  const API_URL = "https://script.google.com/macros/s/AKfycbxAWp75DXAjzfMWJuhNPPlD8iny9vPWpjRCddhhZ5Ck6vhVREq5PvbqTJXZv5Tf9B8K/exec?token=otsukakh5501398";
  const ADMIN_PASSWORD = "admin2153356";
  const VERSION_ID = "SYSTEM_LOG_v6"; 

  let records = [], mode = "user", editingId = null, quill, modalTarget = null, editingYMList = [];
  let endDateManual = false; // true: ä½¿ç”¨è€…å·²æ‰‹å‹•èª¿æ•´ç¶­è­·è¨–æ—¥ï¼ˆé¿å…èµ·æ—¥è®Šå‹•æ™‚è‡ªå‹•è¦†è“‹ï¼‰
  let systemLogs = []; 
  let editingLogVersion = null; 

  let pwdResolve = null;

  // === UX helper: åˆ¤æ–·å‚™è¨»æ˜¯å¦æœ‰å…§å®¹ã€ç”¢ç”Ÿ hover æ‘˜è¦ ===
  function hasMeaningfulNotes(html) {
    if (!html) return false;
    const s = String(html).trim();
    if (!s) return false;
    // å¸¸è¦‹ç©ºå…§å®¹
    if (s === '<p><br></p>' || s === '<p></p>' || s === '<br>') return false;
    // å»æ‰ tag å¾Œå¦‚æœé‚„æœ‰å­—æ‰ç®—
    const text = stripHtmlToText(s).trim();
    return text.length > 0;
  }

  function stripHtmlToText(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    return (div.textContent || div.innerText || '')
      .replace(/\u00A0/g, ' ')   // &nbsp;
      .replace(/[\r\n]+/g, '\n')
      .replace(/[\t ]+/g, ' ')
      .trim();
  }

  function truncateText(s, maxLen = 90) {
    if (!s) return '';
    const str = String(s);
    return str.length > maxLen ? str.slice(0, maxLen - 1) + 'â€¦' : str;
  }

  function escapeAttr(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function requestPassword(title = "è«‹è¼¸å…¥ç³»çµ±å¯†ç¢¼") {
    return new Promise((resolve) => {
      document.getElementById('pwdTitle').textContent = title;
      document.getElementById('inputPwd').value = "";
      document.getElementById('inputPwd').type = "password"; 
      const btnCancel = document.getElementById('btnPwdCancel');
      if (title.includes("ç®¡ç†")) { btnCancel.style.display = 'flex'; } else { btnCancel.style.display = 'none'; }
      
      document.getElementById('pwdModal').style.display = 'block';
      document.getElementById('pwdOverlay').style.display = 'block';
      document.getElementById('inputPwd').focus();
      pwdResolve = resolve;
    });
  }

  function cancelPwdModal() {
    document.getElementById('pwdModal').style.display = 'none';
    document.getElementById('pwdOverlay').style.display = 'none';
    if (pwdResolve) pwdResolve(null);
  }

  function togglePwd() {
    const input = document.getElementById('inputPwd');
    const icon = document.querySelector('.toggle-password');
    if (input.type === "password") {
      input.type = "text";
      icon.textContent = "visibility_off";
    } else {
      input.type = "password";
      icon.textContent = "visibility";
    }
  }

  document.getElementById('btnPwdConfirm').onclick = () => {
    const val = document.getElementById('inputPwd').value;
    document.getElementById('pwdModal').style.display = 'none';
    document.getElementById('pwdOverlay').style.display = 'none';
    if (pwdResolve) pwdResolve(val);
  };
  
  document.getElementById('inputPwd').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') document.getElementById('btnPwdConfirm').click();
  });

  // é—œéµä¿®æ­£ï¼šç¢ºä¿æŒ‰éˆ•æ¯æ¬¡æ‰“é–‹éƒ½æ˜¯å¯ç”¨çš„
  function resetButtonState() {
      const btn = document.querySelector('#formEdit .btn-primary');
      if (btn) {
          btn.innerText = "å„²å­˜ä¸¦åŒæ­¥è‡³è³‡æ–™åº«";
          btn.disabled = false;
      }
  }

  async function load() {
    let pwd = sessionStorage.getItem('sys_pwd');
    if (!pwd) { pwd = await requestPassword("ğŸ”’ è«‹è¼¸å…¥ç³»çµ±å¯†ç¢¼"); }
    if (!pwd) { location.reload(); return; }
    
    try {
      const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`);
      const result = await resp.json();
      
      if (result.status === "error") { 
        alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
        sessionStorage.removeItem('sys_pwd'); 
        location.reload(); 
        return; 
      }
      
      sessionStorage.setItem('sys_pwd', pwd);

      if (result.records) {
         records = result.records;
         systemLogs = result.logs || [];
      } else if (Array.isArray(result)) {
         records = result.filter(r => r.id !== VERSION_ID); 
      }
      
      if(systemLogs.length > 0) {
          document.getElementById('versionTag').textContent = systemLogs[0].version;
      }

      document.getElementById('mainContent').style.display = 'block'; 
      render();
    } catch (e) { 
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); 
        console.error(e);
    }
  }

  function render() {
    const ym = document.getElementById('monthPick').value || new Date().toISOString().slice(0, 7);
    const currentYM = new Date().toISOString().slice(0, 7);
    const q = document.getElementById('q').value.toLowerCase();
    const scope = document.getElementById('scope').value;

    const filtered = records.filter(r => {
      const match = !q || r.customer.toLowerCase().includes(q) || (r.salesName||"").toLowerCase().includes(q) || (r.engineer||"").toLowerCase().includes(q) || r.product.toLowerCase().includes(q);
      const hasSch = (r.schedule || []).some(s => s.ym === ym);
      return (scope === 'need' ? hasSch : true) && match;
    }).sort((a,b) => a.customer.localeCompare(b.customer, 'zh-Hant'));

    document.getElementById('statTotal').textContent = records.length;
    const doneCount = records.filter(r => r.schedule?.some(s => s.ym === ym && (s.isDone || s.ym < currentYM))).length;
    const todoCount = records.filter(r => r.schedule?.some(s => s.ym === ym && (!s.isDone && s.ym >= currentYM))).length;
    document.getElementById('statDone').textContent = doneCount;
    document.getElementById('statTodo').textContent = todoCount;
    document.getElementById('statRate').textContent = (doneCount + todoCount) > 0 ? Math.round((doneCount / (doneCount + todoCount)) * 100) + "%" : "0%";

    const tbody = document.getElementById('rows');
    tbody.innerHTML = '';

    filtered.forEach(r => {
      const sch = (r.schedule || []).find(s => s.ym === ym);

      // âœ… å‚™è¨» UXï¼šæœ‰å…§å®¹æ‰é¡¯ç¤º iconï¼›hover åƒ…é¡¯ç¤ºæç¤ºæ–‡å­—ï¼ˆä¸é¡¯ç¤ºå…§å®¹ï¼‰
      const hasNotes = hasMeaningfulNotes(r.notes);
      const noteTooltip = hasNotes ? "é»æ“ŠæŸ¥çœ‹å‚™è¨»" : "";

      const salesTag = r.salesName ? `<span class="sales-tag" title="æ¥­å‹™">${r.salesName}</span>` : '';
      const engTag = r.engineer ? `<span class="engineer-tag" title="ç¶­è­·å·¥ç¨‹å¸«">${r.engineer}</span>` : '';

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>
            <span style="font-weight:700;">${r.customer}</span>
            ${hasNotes ? `
              <span class="material-symbols-rounded note-indicator"
data-tooltip="${noteTooltip}"
                onclick="openEdit('${r.id}', true)">description</span>
            ` : ''}
          </td>
          <td>
            <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">${r.product}</div>
            <div>${salesTag}${engTag}</div> 
          </td>
          <td style="font-size:0.85rem; color:var(--text-muted);">${r.startDate} ~ ${r.endDate}</td>
          <td>
            <div class="month-group">
              ${(r.schedule || []).map(s => {
                const isPast = s.ym < currentYM;
                return `<span class="month-chip ${(s.isDone || isPast) ? 'is-done' : ''} ${s.ym === ym ? 'active' : ''}">${parseInt(s.ym.slice(5))}æœˆ</span>`;
              }).join('')}
            </div>
          </td>
          <td>
            ${sch ? ((sch.isDone || sch.ym < currentYM) ? `
              <div class="done-status-box">
                <div class="status-title"><span class="material-symbols-rounded" style="font-size:18px;">check_circle</span>å®Œå·¥</div>
                <div class="status-meta">${sch.doneDate || 'ç³»çµ±'}<br>${sch.engName || 'Auto'}</div>
              </div>
            ` : `<span style="color:var(--warning); font-weight:700; display:flex; align-items:center; gap:4px;"><span class="material-symbols-rounded" style="font-size:16px;">pending</span>å¾…ç¶­è­·</span>`) : '--'}
          </td>
          <td>
            <div style="display:flex; gap:6px; justify-content: flex-end;">
              ${sch ? `<button class="btn btn-outline" type="button" style="padding:4px" onclick="toggleDone('${r.id}','${ym}')"><span class="material-symbols-rounded" style="font-size:18px;">${(sch.isDone || sch.ym < currentYM)?'history':'done'}</span></button>` : ''}
              ${mode === 'admin' ? `<button class="btn btn-outline" type="button" style="padding:4px" onclick="openEdit('${r.id}')"><span class="material-symbols-rounded" style="font-size:18px;">edit</span></button>` : ''}
            </div>
          </td>
        </tr>
      `);
    });
  }

  async function save() {
    const btn = document.querySelector('#formEdit .btn-primary');
    const mSaveBtn = document.getElementById('mSave');
    let activeBtn = null;
    let originalText = "";

    if (document.getElementById('drawer').classList.contains('open') && btn) activeBtn = btn;
    else if (document.getElementById('doneModal').style.display === 'block' && mSaveBtn) activeBtn = mSaveBtn;

    if (activeBtn) {
        originalText = activeBtn.innerText;
        activeBtn.innerText = "å„²å­˜ä¸­...";
        activeBtn.disabled = true;
    }

    try {
      const pwd = sessionStorage.getItem('sys_pwd');
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      
      let payload;
      
      if (editingId === VERSION_ID) {
          const verInput = document.getElementById('logVersionInput').value;
          if(!verInput) { alert("è«‹è¼¸å…¥ç‰ˆæœ¬è™Ÿ"); throw new Error("ç„¡ç‰ˆæœ¬è™Ÿ"); }

          if (editingLogVersion) {
             payload = { 
               action: "editLog", 
               data: { targetVersion: editingLogVersion, newVersion: verInput, content: quill.root.innerHTML } 
             };
          } else {
             payload = { 
               action: "addLog", 
               data: { version: verInput, content: quill.root.innerHTML } 
             };
          }
      } else {
          payload = records; 
      }

      const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`, { 
        method: "POST", 
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(timeoutId);

      if (!resp.ok) throw new Error("Network response was not ok");
      const result = await resp.json();
      if (result.result === "error") throw new Error(result.message);

      // å„²å­˜æˆåŠŸå¾Œé‡æ–°è®€å–è³‡æ–™
      await load(); 
      
      // ä¿®æ­£é‡é»ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºæ—¥èªŒç·¨è¼¯ï¼Œå¦‚æœæ˜¯ï¼Œå›åˆ°ã€Œæ—¥èªŒåˆ—è¡¨ã€è€Œä¸æ˜¯é—œé–‰æŠ½å±œ
      if(editingId === VERSION_ID) {
        openSystemLog('view'); 
      } else {
        closeDrawer(); 
      }
      
    } catch (e) {
      if(e.message !== "ç„¡ç‰ˆæœ¬è™Ÿ") {
          alert("å„²å­˜ç¨‹åºå·²åŸ·è¡Œï¼Œä½†å›æ‡‰é€¾æ™‚æˆ–ç™¼ç”ŸéŒ¯èª¤ã€‚\nè«‹é‡æ–°æ•´ç†é é¢ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢ºæ›´æ–°ã€‚");
      }
    } finally {
      // ä¸è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½å¼·åˆ¶é‡ç½®æŒ‰éˆ•æ–‡å­—èˆ‡ç‹€æ…‹
      resetButtonState();
      if (activeBtn && activeBtn !== document.querySelector('#formEdit .btn-primary')) {
          activeBtn.innerText = originalText;
          activeBtn.disabled = false;
      }
    }
  }

  // === ç¶­è­·æœˆä»½ï¼šå­£ç¶­è­· / æœˆç¶­è­·ï¼ˆä¾ç¶­è­·æœŸé–“ï¼‰ ===
  function pad2_(n){ return String(n).padStart(2,'0'); }

  // å®‰å…¨çš„æœ¬åœ°å¹´æœˆå­—ä¸²ï¼ˆé¿å… toISOString é€ æˆæœˆä»½åç§»ï¼‰
  function ymFromYearMonth_(y, m0){ return `${y}-${pad2_(m0+1)}`; }

  // å®‰å…¨çš„æœ¬åœ°æ—¥æœŸå­—ä¸²ï¼ˆYYYY-MM-DDï¼‰
  function dateToYMD_(d){ return `${d.getFullYear()}-${pad2_(d.getMonth()+1)}-${pad2_(d.getDate())}`; }

  // å›å‚³ï¼šç¶­è­·æœŸé–“æ¶µè“‹åˆ°çš„æ¯å€‹æœˆï¼ˆå«èµ·æœˆã€å«è¨–æœˆï¼‰
  function buildMonthlyYMsByRange_(startDate, endDate) {
    const sy = startDate.getFullYear(), sm = startDate.getMonth();
    const ey = endDate.getFullYear(), em = endDate.getMonth();
    const startIdx = sy*12 + sm;
    const endIdx = ey*12 + em;
    if (startIdx > endIdx) return [];
    const out = [];
    for (let idx = startIdx; idx <= endIdx; idx++) {
      const y = Math.floor(idx/12);
      const m0 = idx % 12;
      out.push(ymFromYearMonth_(y, m0));
    }
    return out;
  }

 // å­£ç¶­è­·ï¼šä»¥ã€Œé–‹å§‹æœˆä»½ +2ã€ç‚ºç¬¬ä¸€å€‹ç¶­è­·æœˆï¼Œä¹‹å¾Œæ¯ +3 å€‹æœˆä¸€æ¬¡ï¼Œç›´åˆ°æ¶µè“‹è¨–æœˆ
ã€€function buildQuarterYMsByRange_(startDate, endDate) {
ã€€  const sy = startDate.getFullYear(), sm = startDate.getMonth();
ã€€  const ey = endDate.getFullYear(), em = endDate.getMonth();
ã€€  const startIdx = sy * 12 + sm;
ã€€  const endIdx = ey * 12 + em;
ã€€  if (startIdx > endIdx) return [];

 ã€€ const out = [];

  // ç¬¬ä¸€å€‹å­£ç¶­è­·æœˆï¼šé–‹å§‹æœˆä»½ +2
ã€€  let idx = startIdx + 2;

  // å¦‚æœç¬¬ä¸€å€‹å­£ç¶­è­·æœˆå·²ç¶“è¶…éç¶­è­·è¨–æœˆï¼Œå‰‡æœ¬æœŸé–“ä¸æœƒæœ‰å­£ç¶­è­·æœˆ
  while (idx <= endIdx) {
    const y = Math.floor(idx / 12);
    const m0 = idx % 12;
    out.push(ymFromYearMonth_(y, m0));
    idx += 3;
  }

  return out;
}


  // äº’æ–¥ï¼šcheckbox è¡Œç‚ºåƒ radio
  function setCycleUI_(type) {
    const q = document.getElementById('cycleQuarter');
    const m = document.getElementById('cycleMonth');
    if (!q || !m) return;
    if (type === 'month') { m.checked = true; q.checked = false; }
    else { q.checked = true; m.checked = false; }
  }


  // åˆ¤æ–·æ—¢æœ‰æœˆä»½æ¸…å–®æ˜¯å¦ç‚ºã€Œæ¯æœˆé€£çºŒã€
  function isConsecutiveMonthly_(ymList) {
    if (!ymList || ymList.length < 2) return false;
    const dates = ymList.map(ym => new Date(ym + "-01")).sort((a,b) => a - b);
    for (let i = 1; i < dates.length; i++) {
      const prev = dates[i - 1];
      const cur = dates[i];
      const expected = new Date(prev.getFullYear(), prev.getMonth() + 1, 1);
      if (expected.getTime() !== cur.getTime()) return false;
    }
    return true;
  }

  function computeYMListByCycle_(startDate, endDate) {
    const isMonthly = document.getElementById('cycleMonth')?.checked;
    return isMonthly ? buildMonthlyYMsByRange_(startDate, endDate) : buildQuarterYMsByRange_(startDate, endDate);
  }

  // source: 'start' | 'end' | undefined
  function handleDateChange(source) {
    const startVal = document.getElementById('startDate').value;
    if(!startVal) return;

    // èµ·æ—¥è®Šæ›´ï¼šè‹¥è¨–æ—¥æœªæ‰‹å‹•èª¿æ•´ï¼Œç¶­æŒåŸæœ¬ã€Œé è¨­ 1 å¹´æœŸã€è‡ªå‹•å¸¶å…¥
    if (source === 'start') endDateManual = false;
    if (source === 'end') endDateManual = true;

    const startDate = new Date(startVal);

    let endVal = document.getElementById('endDate').value;
    if (!endVal || !endDateManual) {
      const endDateAuto = new Date(startVal);
      endDateAuto.setFullYear(startDate.getFullYear() + 1);
      endDateAuto.setDate(endDateAuto.getDate() - 1);
      document.getElementById('endDate').value = dateToYMD_(endDateAuto);
      endVal = document.getElementById('endDate').value;
    }

    if (!endVal) return;
    const endDate = new Date(endVal);

    editingYMList = computeYMListByCycle_(startDate, endDate);
    renderYMList();
  }

  function onCycleToggle(type) {
    setCycleUI_(type);

    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    if (!startVal || !endVal) {
      alert("è«‹å…ˆé¸æ“‡ã€Œç¶­è­·èµ·æ—¥ã€èˆ‡ã€Œç¶­è­·è¨–æ—¥ã€å¾Œï¼Œå†åˆ‡æ›å­£ç¶­è­· / æœˆç¶­è­·ã€‚");
      setCycleUI_('quarter');
      return;
    }

    const startDate = new Date(startVal);
    const endDate = new Date(endVal);

    editingYMList = computeYMListByCycle_(startDate, endDate);
    renderYMList();
  }

  function addYM() {
    const val = document.getElementById('manualYM').value;
    if(val && !editingYMList.includes(val)) { editingYMList.push(val); editingYMList.sort(); renderYMList(); }
  }
  function removeYM(ym) { editingYMList = editingYMList.filter(x => x !== ym); renderYMList(); }
  function renderYMList() {
    document.getElementById('ymList').innerHTML = editingYMList.map(ym => `
      <div class="ym-tag">${ym} <span onclick="removeYM('${ym}')" style="cursor:pointer; color:var(--danger); font-weight:bold;">Ã—</span></div>
    `).join('');
  }

  function openEdit(id = null, forceReadOnly = false) {
    resetButtonState();

    document.getElementById('logVersionField').style.display = 'none';
    document.getElementById('customerFields').style.display = 'block';

    document.getElementById('adminOnlyFields').style.display = 'block';
    document.getElementById('adminAction').style.display = 'block';
    editingId = id;
    const r = records.find(x => x.id === id) || { customer:"", product:"ee-class", salesName:"Willa", engineer:"", startDate:"", endDate:"", notes:"", schedule: [] };
    const isViewOnly = forceReadOnly || mode === 'user';
    
    document.getElementById('adminOnlyFields').style.display = isViewOnly ? 'none' : 'block';
    document.getElementById('adminAction').style.display = isViewOnly ? 'none' : 'block';
    document.getElementById('btnDelete').style.display = (isViewOnly || !id) ? 'none' : 'block';
    document.getElementById('drawerTitle').textContent = isViewOnly ? "å‚™è¨»å…§å®¹" : (id ? "ç·¨è¼¯ç¶­è­·" : "æ–°å¢ç¶­è­·");
    
    if(isViewOnly) {
      document.getElementById('editor-wrapper').style.display = 'none';
      document.getElementById('note-viewer').style.display = 'block';
      document.getElementById('note-viewer').innerHTML = r.notes || "å°šç„¡å‚™è¨»";
    } else {
      document.getElementById('editor-wrapper').style.display = 'block';
      document.getElementById('note-viewer').style.display = 'none';
      quill.root.innerHTML = r.notes || "";
    }
    
    document.getElementById('customer').value = r.customer || "";
    document.getElementById('product').value = r.product || "ee-class";
    document.getElementById('salesName').value = r.salesName || "Willa";
    document.getElementById('engineer').value = r.engineer || "";
    document.getElementById('startDate').value = r.startDate || "";
    document.getElementById('endDate').value = r.endDate || "";
    endDateManual = !!r.endDate; // ç·¨è¼¯æ—¢æœ‰è³‡æ–™æ™‚ï¼Œè¦–ç‚ºå·²æ‰‹å‹•è¨­å®šè¨–æ—¥ï¼ˆé¿å…èµ·æ—¥è®Šæ›´è¦†è“‹ï¼‰

    editingYMList = (r.schedule || []).map(s => s.ym);

    // ä¾æ—¢æœ‰æœˆä»½æ¸…å–®è‡ªå‹•åˆ¤æ–·å­£/æœˆç¶­è­·ï¼ˆæ²’æœ‰æ¸…å–®æ™‚é è¨­å­£ç¶­è­·ï¼‰
    if (editingYMList.length > 0 && isConsecutiveMonthly_(editingYMList)) setCycleUI_('month');
    else setCycleUI_('quarter');

    renderYMList();
    document.getElementById('drawer').classList.add('open');
    document.getElementById('overlay').style.display = 'block';
  }

  function openSystemLog(action) {
    resetButtonState();

    editingId = VERSION_ID;
    document.getElementById('drawerTitle').textContent = "ç³»çµ±æ›´æ–°æ—¥èªŒ";
    
    // === æª¢è¦–æ¨¡å¼ ===
    if (action === 'view') {
        document.getElementById('adminOnlyFields').style.display = 'none';
        document.getElementById('adminAction').style.display = 'none';
        document.getElementById('editor-wrapper').style.display = 'none';
        document.getElementById('note-viewer').style.display = 'block';

        if (systemLogs.length === 0) {
            document.getElementById('note-viewer').innerHTML = '<div style="text-align:center;color:#999;padding:20px;">å°šç„¡ç´€éŒ„</div>';
        } else {
            const cardsHtml = systemLogs.map(log => {
                let actionBtns = '';
                if (mode === 'admin') {
                    actionBtns = `
                    <div class="log-actions">
                        <button type="button" class="btn btn-outline" style="padding:2px 8px; font-size:12px;" onclick="editLogEntry('${log.version}')">ç·¨è¼¯</button>
                        <button type="button" class="btn btn-danger-text" onclick="deleteLogEntry('${log.version}')">åˆªé™¤</button>
                    </div>`;
                }
                return `
                <div class="log-card">
                    <div class="log-header">
                        <span class="log-version">${log.version}</span>
                        <span class="log-date">${log.date}</span>
                    </div>
                    <div class="log-content">${log.content}</div>
                    ${actionBtns}
                </div>`;
            }).join('');
            document.getElementById('note-viewer').innerHTML = cardsHtml;
        }

    } else {
        // === æ–°å¢æ¨¡å¼ ===
        editingLogVersion = null;
        document.getElementById('adminOnlyFields').style.display = 'block';
        document.getElementById('customerFields').style.display = 'none';
        document.getElementById('logVersionField').style.display = 'block';
        document.getElementById('btnDelete').style.display = 'none';
        
        document.getElementById('adminAction').style.display = 'block';
        document.getElementById('editor-wrapper').style.display = 'block';
        document.getElementById('note-viewer').style.display = 'none';
        
        const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
        document.getElementById('logVersionInput').value = "v" + today;
        quill.root.innerHTML = ""; 
        document.getElementById('noteLabel').textContent = "æœ¬æ¬¡æ›´æ–°å…§å®¹";
    }
    
    document.getElementById('drawer').classList.add('open');
    document.getElementById('overlay').style.display = 'block';
  }

  function editLogEntry(version) {
      resetButtonState();

      const log = systemLogs.find(l => l.version === version);
      if (!log) return;

      editingLogVersion = version; 
      document.getElementById('adminOnlyFields').style.display = 'block';
      document.getElementById('customerFields').style.display = 'none';
      document.getElementById('logVersionField').style.display = 'block';
      document.getElementById('btnDelete').style.display = 'none';
      
      document.getElementById('adminAction').style.display = 'block';
      document.getElementById('editor-wrapper').style.display = 'block';
      document.getElementById('note-viewer').style.display = 'none';
      
      document.getElementById('logVersionInput').value = log.version;
      quill.root.innerHTML = log.content;
      document.getElementById('noteLabel').textContent = "ç·¨è¼¯æ›´æ–°å…§å®¹";
  }

  async function deleteLogEntry(version) {
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ç‰ˆæœ¬ ${version} çš„æ—¥èªŒå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
      
      const pwd = sessionStorage.getItem('sys_pwd');
      const payload = { action: "deleteLog", data: { targetVersion: version } };
      
      try {
          const resp = await fetch(`${API_URL}&pwd=${encodeURIComponent(pwd)}`, { 
            method: "POST", 
            body: JSON.stringify(payload)
          });
          const result = await resp.json();
          if (result.result === "success") {
              alert("åˆªé™¤æˆåŠŸ");
              await load(); 
              openSystemLog('view'); 
          } else {
              alert("åˆªé™¤å¤±æ•—ï¼š" + result.message);
          }
      } catch(e) {
          alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
      }
  }

  document.getElementById('formEdit').onsubmit = async (e) => {
    e.preventDefault();

    // âœ… é˜²å‘†ï¼šé¿å…ä»»ä½•éå„²å­˜æŒ‰éˆ•é€ æˆ submit
    const submitter = e.submitter;
    if (submitter && submitter.type !== 'submit') return;

    if (editingId === VERSION_ID) {
        await save(); 
        return;
    }
    
    const rData = {
      id: editingId || 'ID-' + Date.now(),
      customer: document.getElementById('customer').value,
      product: document.getElementById('product').value,
      salesName: document.getElementById('salesName').value,
      engineer: document.getElementById('engineer').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      notes: quill.root.innerHTML === '<p><br></p>' ? '' : quill.root.innerHTML,
      schedule: editingYMList.map(ym => {
        const old = (records.find(x => x.id === editingId)?.schedule || []).find(s => s.ym === ym);
        if (old) return old;
        const currentYM = new Date().toISOString().slice(0, 7);
        const isPast = ym < currentYM;
        return { ym, isDone: isPast, doneDate: isPast ? currentYM : "", engName: isPast ? "Auto" : "" };
      })
    };
    const idx = records.findIndex(x => x.id === rData.id);
    if (idx !== -1) records[idx] = rData; else records.push(rData);
    await save(); 
  };

  function toggleDone(id, ym) {
    const r = records.find(x => x.id === id);
    const sch = r.schedule.find(s => s.ym === ym);
    const currentYM = new Date().toISOString().slice(0, 7);
    if(sch.isDone || sch.ym < currentYM) {
      if(confirm("ç¢ºå®šå–æ¶ˆå®Œå·¥ï¼Ÿ")) { sch.isDone = false; save(); }
    } else {
      modalTarget = { id, ym };
      document.getElementById('mDoneDate').value = new Date().toISOString().slice(0,10);
      document.getElementById('doneModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
  }

  function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').style.display = 'none'; closeModal(); }
  function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('overlay').style.display = 'none'; }
  document.getElementById('btnDelete').onclick = async () => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤å®¢æˆ¶ï¼Ÿ")) { records = records.filter(x => x.id !== editingId); await save(); closeDrawer(); } };

  document.getElementById('mSave').onclick = async () => {
    const r = records.find(x => x.id === modalTarget.id);
    const sch = r.schedule.find(s => s.ym === modalTarget.ym);
    sch.isDone = true; 
    sch.engName = document.getElementById('mEngName').value; 
    sch.doneDate = document.getElementById('mDoneDate').value;
    await save(); closeModal();
  };

  document.getElementById('modeSeg').onclick = async (e) => {
    const b = e.target.closest('button'); if(!b) return;
    if (b.dataset.mode === 'admin') {
      const input = await requestPassword("ç®¡ç†è€…å¯†ç¢¼");
      if (input !== ADMIN_PASSWORD) { if(input !== null) alert("å¯†ç¢¼éŒ¯èª¤"); return; }
    }
    mode = b.dataset.mode;
    document.querySelectorAll('.mode-btn').forEach(x => x.classList.toggle('active', x===b));
    document.getElementById('adminControls').style.display = mode === 'admin' ? 'flex' : 'none';
    render();
  };

  document.addEventListener('DOMContentLoaded', () => {
    quill = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: [[{ 'size': ['small', false, 'large', 'huge'] }], ['bold', 'underline', 'link'], [{ 'color': [] }, { 'background': [] }], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] } });
    document.getElementById('monthPick').value = new Date().toISOString().slice(0, 7);
    load();
  });
  document.getElementById('q').oninput = render;
  document.getElementById('monthPick').onchange = render;
  document.getElementById('scope').onchange = render;
</script>
</body>
</html>




